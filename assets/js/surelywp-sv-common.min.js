"use strict";jQuery(document).ready((function(e){FilePond.registerPlugin(FilePondPluginFileEncode,FilePondPluginFileValidateSize,FilePondPluginImageExifOrientation,FilePondPluginImagePreview,FilePondPluginFileValidateType);const s=FilePond.create(document.querySelector(".messages-filepond"),{acceptedFileTypes:sv_common_ajax_object.file_types,allowFileEncode:!1,allowMultiple:!0,labelIdle:wp.i18n.__("Drag & Drop your files","surelywp-services")+' <span class="filepond--label-action">'+wp.i18n.__("or Browse","surelywp-services")+"</span>"});if(e(".status-tracker").length){var a=e(".service-track-list sc-text.checked").last().next("sc-text");a.length&&a.addClass("active")}e("#service-message-input").keypress((function(s){"Enter"===s.key&&(s.preventDefault(),e(".surelywp-sv-message-form").submit())})),setTimeout(c,100);var t=!1;function r(s){var a=e("#surelywp_sv_message_form_submit_nonce").val();e.ajax({url:sv_common_ajax_object.ajax_url,type:"POST",dataType:"json",data:{action:"surelywp_sv_send_message_mail",nonce:a,message_data:s}})}if(e(document).on("scFormSubmit",(function(a){if(e(".alert-msg").length>0&&e(".alert-msg").remove(),"surelywp-sv-message-form"==a.target.classList[0]){if(t)return;a.preventDefault(),t=!0,e("#surelywp-sv-send-message-btn").attr("loading","true"),e("#surelywp-sv-send-message-btn").attr("disabled","true");var i=new FormData,l=e("#surelywp_sv_message_form_submit_nonce").val(),n=e("#surelywp-sv-service-id").val(),o=e("#surelywp-sv-service-setting-id").val(),d=e("#message-receiver-id").val(),m=0,u=e("#is-final-delivery").is(":checked")?1:0,p=e("#is-final-delivery").attr("data-milestone");m=0!==parseInt(p)?1:0;var _=s.getFiles();e.each(_,(function(e,a){2==a.status?i.append("msg_attachment_file[]",a.file):s.removeFile(a.id)})),i.append("action","surelywp_sv_message_form_sumbit_callback"),i.append("service_id",n),i.append("service_setting_id",o),i.append("receiver_id",d),i.append("is_final_delivery",u),i.append("is_milestone_delivery_flag",m),i.append("is_milestone_delivery",p),i.append("nonce",l),a.target.getFormJson().then((a=>{var l=tinyMCE.get("service-message-input")?tinyMCE.get("service-message-input").getContent():e("#service-message-input").val();if(""===l&&(l=e("#service-message-input").val()),""==l)return v(".services-tabs",wp.i18n.__("Please enter your message and try again.","surelywp-services"),"danger"),jQuery("html, body").animate({scrollTop:0},800),e("#surelywp-sv-send-message-btn").attr("loading","false"),e("#surelywp-sv-send-message-btn").removeAttr("disabled"),void(t=!1);i.append("service_message",l),e.ajax({url:sv_common_ajax_object.ajax_url,type:"POST",dataType:"json",data:i,processData:!1,contentType:!1,success:function(a){u?(r(a.message_data),window.location.reload()):(a.success||v(".services-tabs",a.message,"danger"),c(),tinyMCE.get("service-message-input")&&tinyMCE.get("service-message-input").setContent(""),e("#service-message-input").val(""),setTimeout((function(){s.removeFiles()}),100),t=!1,e("#surelywp-sv-send-message-btn").attr("loading","false"),e("#surelywp-sv-send-message-btn").removeAttr("disabled"),r(a.message_data))}})})).catch((e=>{console.error("Error:",e)}))}})),e(".surelywp-sv-messages.admin").length>0){if("service_submit"===e("#surelywp-sv-service-status").val())var i=setInterval((function(){var s=e("#surelywp_sv_message_form_submit_nonce").val(),a=e("#surelywp-sv-service-id").val(),t=e(".delivery-message.top:last").next(".surelywp-sv-msg:first").data("message-id");e.ajax({url:sv_common_ajax_object.ajax_url,dataType:"json",type:"POST",data:{action:"surelywp_sv_check_delivery_status",service_id:a,message_id:t,nonce:s},success:function(e){e.success&&e.is_status_update&&(window.location.reload(),clearInterval(i))}}).catch((e=>{console.error("Error:",e)}))}),2500);var l=setInterval(n,3e3)}else if(e(".surelywp-sv-messages.customer").length>0)l=setInterval(n,3e3);function n(){var s=e("#surelywp_sv_message_form_submit_nonce").val(),a=e("#surelywp-sv-service-id").val(),t=e(".surelywp-sv-msg:last").find("p.complete-datetime").text();e.ajax({url:sv_common_ajax_object.ajax_url,dataType:"json",type:"POST",data:{action:"surelywp_sv_fetch_service_messages",service_id:a,last_message_datatime:t,nonce:s},success:function(s){if(s.success)if(s.is_final_delivery)window.location.reload(),clearInterval(l);else if(t=e(".surelywp-sv-msg:last").find("p.complete-datetime").text(),s.message_time>t){var a=e(".surelywp-sv-messages"),r=a.find(".surelywp-sv-msg:last");r.length>0?r.next(".delivery-message.bottom").length?r.next(".delivery-message.bottom").after(s.message_html):r.after(s.message_html):a.append(s.message_html),c()}}}).catch((e=>{console.error("Error:",e)}))}function c(){var s=e(".surelywp-sv-messages");s.length&&s.scrollTop(s.prop("scrollHeight"))}var o=!1;function v(s,a,t){e(s).after("<sc-alert closable='true' duration=2000 class='alert-msg' open type='"+t+"'>"+a+"</sc-alert>")}e(".surelywp-sv-messages").scroll((function(){var s=e(".surelywp-sv-messages").scrollTop(),a=e(".surelywp-sv-messages");if(0===s&&a.scrollTop(2),!o&&0===s&&0==e("#load-more-loader").length){a.prepend('<sc-spinner class="load-more-loader" id="load-more-loader"></sc-spinner>');var t=e("#surelywp_sv_message_form_submit_nonce").val(),r=e("#surelywp-sv-service-id").val(),i=e(".surelywp-sv-msg:first").find("p.complete-datetime").text();e.ajax({url:sv_common_ajax_object.ajax_url,dataType:"json",type:"POST",data:{action:"surelywp_sv_load_more_service_messages",nonce:t,service_id:r,first_message_datatime:i},success:function(s){e("#load-more-loader").remove(),s.success?a.prepend(s.message_html):o=!0}}).catch((s=>{e("#load-more-loader").remove(),console.error("Error:",s)}))}})),e(document).on("click",".services-tabs ul li",(function(s){s.preventDefault(),e(".services-tabs ul li").removeClass("active"),e(this).addClass("active"),e(".services-chats-wrap, .services-activity-wrap, .services-contract-wrap, .services-requirements-wrap, .services-delivery-wrap").addClass("hidden");var a=e(this).attr("class");a.includes("messages")?e(".services-chats-wrap").removeClass("hidden"):a.includes("activity")?e(".services-activity-wrap").removeClass("hidden"):a.includes("contract")?e(".services-contract-wrap").removeClass("hidden"):a.includes("requirements")?e(".services-requirements-wrap").removeClass("hidden"):a.includes("delivery")&&e(".services-delivery-wrap").removeClass("hidden")})),e(document).on("click","#service-requirements-view",(function(s){s.preventDefault(),e(".services-tabs ul li").removeClass("active"),e(".services-tabs ul li.requirements").addClass("active"),e(".services-chats-wrap, .services-activity-wrap").addClass("hidden"),e(".services-requirements-wrap").removeClass("hidden")})),e(document).on("click",".close-button",(function(s){e(this).closest(".surelywp-sv-modal").find(".modal").removeClass("show-modal")}))}));